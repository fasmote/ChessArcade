<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Matrix - ChessArcade</title>
    <meta name="description" content="Entrena tu memoria ajedrec√≠stica con Memory Matrix. Aprende estructuras de aperturas y mates famosos desde nivel principiante hasta Gran Maestro.">
    
    <!-- OBLIGATORIOS: Google AdSense + Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2472413468382197" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N3EKXHPD5Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-N3EKXHPD5Y');
    </script>
    
    <!-- Fuentes y estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Chessground CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@chessground/chessground/assets/chessground.base.css">
    <link rel="stylesheet" href="https://unpkg.com/@chessground/chessground/assets/chessground.brown.css">

    <link rel="stylesheet" href="../../assets/css/chessarcade-shared.css">
    <link rel="stylesheet" href="memory-matrix.css">
</head>

<body>
    <div class="game-container chess-arcade-bg">
        
        <!-- OBLIGATORIOS: Botones flotantes -->
        <div class="home-toggle" id="homeBtn" title="Volver al inicio">üè†</div>
        <div class="sound-toggle" id="soundToggle" title="Toggle Sound">üîä</div>
        
        <!-- Header del juego -->
        <div class="game-header">
            <div class="game-title">üß† MEMORY MATRIX</div>
            <div class="game-subtitle">Master chess patterns through memory!</div>
        </div>
        
        <!-- UI de estado del juego -->
        <div class="game-ui">
            <div class="level-info">
                <div class="level-number" id="levelNumber">1</div>
                <div class="level-name" id="levelName">DOS REYES SOLOS</div>
                <div class="level-phase" id="levelPhase">üî∏ Estructura Base</div>
                <div class="level-description" id="levelDescription">Los reyes nunca pueden estar juntos</div>
            </div>
            
            <div class="memory-stats">
                <div class="pieces-total">Piezas: <span id="piecesTotal">2</span></div>
                <div class="pieces-hidden">Ocultas: <span id="piecesHidden">2</span></div>
                <div class="view-time">Vista: <span id="viewTime">8.0s</span></div>
            </div>
            
            <div class="score-info">
                <div class="score">Score: <span id="score">0</span></div>
                <div class="accuracy">Precisi√≥n: <span id="accuracy">100%</span></div>
                <div class="progress">
                    Nivel <span id="currentLevel">1</span>/30
                </div>
            </div>
        </div>
        
        <!-- Panel de informaci√≥n hist√≥rica/educativa -->
        <div class="educational-panel" id="educationalPanel">
            <div class="panel-title" id="panelTitle">üè∞ Informaci√≥n de Apertura</div>
            <div class="panel-content" id="panelContent">
                <div class="opening-info" id="openingInfo" style="display:none;">
                    <div class="opening-name" id="openingName"></div>
                    <div class="opening-moves" id="openingMoves"></div>
                    <div class="opening-ideas" id="openingIdeas"></div>
                </div>
                <div class="mate-info" id="mateInfo" style="display:none;">
                    <div class="mate-name" id="mateName"></div>
                    <div class="historical-context" id="historicalContext"></div>
                    <div class="mate-pattern" id="matePattern"></div>
                </div>
            </div>
        </div>
        
        <!-- Banner Ad Superior -->
        <div class="ad-banner-top">
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2472413468382197" data-ad-slot="1111111111" data-ad-format="auto"></ins>
        </div>
        
        <!-- √Årea de visualizaci√≥n de posici√≥n -->
        <div class="position-display" id="positionDisplay">
            <div class="chess-board-container">
                <div class="chess-board" id="chessboard">
                    <!-- Tablero generado por JS -->
                </div>
                <div class="position-overlay" id="boardOverlay" style="display:none;">
                    <div class="overlay-text" id="overlayText">¬°Memoriza la posici√≥n!</div>
                    <div class="overlay-countdown" id="overlayCountdown">8</div>
                    <div class="phase-indicator" id="phaseIndicator">üß† Fase de memoria</div>
                </div>

                <!-- Banco de piezas lateral -->
                <div class="piece-bank-container" id="pieceBankContainer" style="display:none;">
                    <div class="bank-title">Coloca en el tablero:</div>
                    <div class="piece-bank" id="pieceBank">
                        <!-- Piezas generadas din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controles del juego -->
        <div class="game-controls">
            <button class="btn btn-primary" id="startBtn">EMPEZAR NIVEL</button>
            <button class="btn btn-secondary" id="pauseBtn" disabled>PAUSA</button>
            <button class="btn btn-secondary" id="hintBtn">PISTA</button>
            <button class="btn btn-secondary" id="skipPhaseBtn">SALTAR FASE</button>
        </div>
        
        <!-- Feedback de colocaci√≥n -->
        <div class="feedback-display" id="feedbackDisplay" style="display:none;">
            <div class="feedback-icon" id="feedbackIcon">‚úÖ</div>
            <div class="feedback-text" id="feedbackText">¬°Correcto!</div>
            <div class="feedback-explanation" id="feedbackExplanation">Has colocado la pieza en el lugar correcto</div>
        </div>
        
        <!-- Pantalla de completar nivel -->
        <div class="level-complete" id="levelCompleteScreen">
            <div class="level-complete-content">
                <div class="complete-title" id="completeTitle">¬°NIVEL COMPLETADO!</div>
                <div class="complete-stats">
                    <div class="final-score">Puntuaci√≥n: <span id="finalScore">0</span></div>
                    <div class="accuracy-final">Precisi√≥n: <span id="accuracyFinal">100%</span></div>
                    <div class="time-total">Tiempo total: <span id="timeTotal">45s</span></div>
                    <div class="phase-summary" id="phaseSummary">3/3 fases completadas</div>
                </div>
                
                <!-- Informaci√≥n educativa -->
                <div class="lesson-learned" id="lessonLearned">
                    <div class="lesson-title">üìö Has aprendido:</div>
                    <div class="lesson-content" id="lessonContent"></div>
                </div>
                
                <!-- Banner Ad Interstitial -->
                <div class="ad-interstitial">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2472413468382197" data-ad-slot="2222222222" data-ad-format="auto"></ins>
                </div>
                
                <div class="level-complete-actions">
                    <button class="btn btn-primary" id="nextLevelBtn">SIGUIENTE NIVEL</button>
                    <button class="btn btn-secondary" id="repeatLevelBtn">REPETIR NIVEL</button>
                    <button class="btn btn-secondary" id="mainMenuBtn">MEN√ö PRINCIPAL</button>
                </div>
            </div>
        </div>
        
        <!-- Banner Ad Inferior -->
        <div class="ad-banner-bottom">
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2472413468382197" data-ad-slot="3333333333" data-ad-format="auto"></ins>
        </div>
        
    </div>
    
    <!-- Scripts -->
    <!-- Fallback Audio (opcional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

    <!-- Native Chess Board Implementation -->
    <script>
        // Piezas con clases CSS para SVG
        const PIECES = {
            'K': 'white-king', 'Q': 'white-queen', 'R': 'white-rook',
            'B': 'white-bishop', 'N': 'white-knight', 'P': 'white-pawn',
            'k': 'black-king', 'q': 'black-queen', 'r': 'black-rook',
            'b': 'black-bishop', 'n': 'black-knight', 'p': 'black-pawn'
        };

        // Estado global del juego
        window.gameState = {
            level: 1,
            position: {'e1': 'K', 'e8': 'k'},
            hiddenSquares: [],
            memoryPhase: false,
            placementPhase: false,
            correctPlacements: 0,
            score: 0,
            accuracy: 100,
            pieceBank: [],
            draggedPiece: null
        };

        // Crear tablero CSS nativo
        function createNativeBoard() {
            const boardElement = document.getElementById('chessboard');
            if (!boardElement) return;

            boardElement.innerHTML = '';
            boardElement.style.cssText = `
                display: grid;
                grid-template-columns: repeat(8, 1fr);
                grid-template-rows: repeat(8, 1fr);
                width: 480px;
                height: 480px;
                border: 3px solid var(--neon-cyan);
                border-radius: 10px;
            `;

            // Crear 64 casillas
            for (let rank = 8; rank >= 1; rank--) {
                for (let file = 1; file <= 8; file++) {
                    const square = document.createElement('div');
                    const fileName = String.fromCharCode(96 + file);
                    const squareName = fileName + rank;

                    square.className = 'square ' + ((rank + file) % 2 === 0 ? 'dark' : 'light');
                    square.id = squareName;
                    square.setAttribute('data-square', squareName);
                    square.style.cssText = `
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 3rem;
                        cursor: pointer;
                        user-select: none;
                        transition: all 0.2s ease;
                    `;

                    if ((rank + file) % 2 === 0) {
                        square.style.background = '#b58863';
                        square.style.color = '#f0d9b5';
                    } else {
                        square.style.background = '#f0d9b5';
                        square.style.color = '#8b4513';
                    }

                    square.addEventListener('click', () => handleSquareClick(squareName));
                    boardElement.appendChild(square);
                }
            }

            renderPosition();
            console.log('‚úÖ Tablero CSS nativo creado correctamente');
        }

        function renderPosition() {
            document.querySelectorAll('.square').forEach(sq => {
                sq.innerHTML = '';
                sq.classList.remove('target', 'hidden');
            });

            // Colocar piezas con SVG
            for (const [square, piece] of Object.entries(window.gameState.position)) {
                const squareElement = document.getElementById(square);
                if (squareElement) {
                    const pieceElement = document.createElement('div');
                    pieceElement.className = `piece ${PIECES[piece]}`;
                    pieceElement.draggable = false; // No arrastrable desde el tablero
                    squareElement.appendChild(pieceElement);
                }
            }

            // Marcar casillas ocultas
            window.gameState.hiddenSquares.forEach(square => {
                const squareElement = document.getElementById(square);
                if (squareElement) {
                    squareElement.classList.add('hidden');
                    squareElement.innerHTML = '';
                }
            });

            // Marcar casillas objetivo en fase de colocaci√≥n
            if (window.gameState.placementPhase) {
                window.gameState.hiddenSquares.forEach(square => {
                    const squareElement = document.getElementById(square);
                    if (squareElement) {
                        squareElement.classList.add('target');
                    }
                });
            }
        }

        // Crear banco de piezas
        function createPieceBank() {
            const bankContainer = document.getElementById('pieceBankContainer');
            const bankElement = document.getElementById('pieceBank');

            if (!bankContainer || !bankElement) return;

            // Limpiar banco
            bankElement.innerHTML = '';
            window.gameState.pieceBank = [];

            // Agregar las piezas que necesitan ser colocadas
            const originalPosition = {'e1': 'K', 'e8': 'k'}; // Nivel 1 configuraci√≥n
            window.gameState.hiddenSquares.forEach(square => {
                const piece = originalPosition[square];
                if (piece) {
                    const bankPiece = createDraggablePiece(piece, square);
                    bankElement.appendChild(bankPiece);
                    window.gameState.pieceBank.push({piece, square});
                }
            });

            // Mostrar banco
            bankContainer.style.display = 'flex';
        }

        function createDraggablePiece(piece, targetSquare) {
            const container = document.createElement('div');
            container.className = 'draggable-piece';
            container.draggable = true;
            container.dataset.piece = piece;
            container.dataset.target = targetSquare;

            const pieceElement = document.createElement('div');
            pieceElement.className = `piece ${PIECES[piece]}`;
            container.appendChild(pieceElement);

            // Indicador de arrastre
            const indicator = document.createElement('div');
            indicator.className = 'drag-indicator';
            indicator.textContent = '‚§µ';
            container.appendChild(indicator);

            // Event listeners para drag & drop
            container.addEventListener('dragstart', handleDragStart);
            container.addEventListener('dragend', handleDragEnd);

            return container;
        }

        function handleDragStart(e) {
            window.gameState.draggedPiece = {
                piece: e.target.dataset.piece,
                target: e.target.dataset.target,
                element: e.target
            };

            e.target.classList.add('dragging');
            document.getElementById('pieceBank').classList.add('active');

            // Datos para el drag & drop
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.piece);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.getElementById('pieceBank').classList.remove('active');
            window.gameState.draggedPiece = null;
        }

        function setupDropZones() {
            document.querySelectorAll('.square').forEach(square => {
                square.addEventListener('dragover', handleDragOver);
                square.addEventListener('drop', handleDrop);
            });
        }

        function handleDragOver(e) {
            if (window.gameState.draggedPiece && window.gameState.placementPhase) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDrop(e) {
            e.preventDefault();

            if (!window.gameState.draggedPiece || !window.gameState.placementPhase) return;

            const targetSquare = e.target.closest('.square').id;
            const draggedPiece = window.gameState.draggedPiece;

            // Verificar si es la casilla correcta
            if (targetSquare === draggedPiece.target) {
                // Colocaci√≥n correcta
                window.gameState.position[targetSquare] = draggedPiece.piece;
                window.gameState.correctPlacements++;
                window.gameState.hiddenSquares = window.gameState.hiddenSquares.filter(s => s !== targetSquare);

                // Remover pieza del banco
                draggedPiece.element.remove();

                renderPosition();
                showFeedback('‚úÖ ¬°Correcto!', true);

                // Verificar completado
                if (window.gameState.correctPlacements >= 2) {
                    setTimeout(() => {
                        showFeedback('üèÜ ¬°NIVEL COMPLETADO!', true);
                        document.getElementById('pieceBankContainer').style.display = 'none';
                    }, 1000);
                }
            } else {
                // Colocaci√≥n incorrecta
                showFeedback('‚ùå Casilla incorrecta', false);

                // Animar vuelta al banco
                draggedPiece.element.classList.add('piece-return');
                setTimeout(() => {
                    draggedPiece.element.classList.remove('piece-return');
                }, 800);
            }
        }

        function handleSquareClick(square) {
            // El click ahora es secundario al drag & drop
            if (!window.gameState.placementPhase) return;

            // Solo para fallback en mobile si drag & drop no funciona
            if ('ontouchstart' in window) {
                if (!window.gameState.hiddenSquares.includes(square)) {
                    showFeedback('‚ùå Casilla incorrecta', false);
                    return;
                }

                let correctPiece;
                if (square === 'e1') correctPiece = 'K';
                else if (square === 'e8') correctPiece = 'k';

                window.gameState.position[square] = correctPiece;
                window.gameState.correctPlacements++;
                window.gameState.hiddenSquares = window.gameState.hiddenSquares.filter(s => s !== square);

                renderPosition();

                if (window.gameState.correctPlacements >= 2) {
                    showFeedback('üèÜ ¬°NIVEL COMPLETADO!', true);
                } else {
                    showFeedback('‚úÖ ¬°Correcto!', true);
                }
            }
        }

        function showFeedback(message, isCorrect) {
            const feedbackElement = document.getElementById('feedbackDisplay');
            if (feedbackElement) {
                feedbackElement.style.display = 'block';
                document.getElementById('feedbackText').textContent = message;
                document.getElementById('feedbackIcon').textContent = isCorrect ? '‚úÖ' : '‚ùå';
                setTimeout(() => {
                    feedbackElement.style.display = 'none';
                }, 2000);
            }
        }

        function updateUI() {
            document.getElementById('score').textContent = window.gameState.score;
            document.getElementById('accuracy').textContent = window.gameState.accuracy + '%';
        }

        // Inicializar
        window.addEventListener('load', function() {
            console.log('üß† Memory Matrix - Versi√≥n Mejorada con Drag & Drop');
            createNativeBoard();
            setupDropZones();
        });
    </script>

    <!-- Game Files (simplificados) -->
    <script src="memory-levels.js"></script>
    <script>
        // Controlador principal simplificado
        function startGame() {
            console.log('üéØ Iniciando nivel 1');

            window.gameState.position = {'e1': 'K', 'e8': 'k'};
            window.gameState.hiddenSquares = [];
            window.gameState.memoryPhase = true;
            window.gameState.placementPhase = false;
            window.gameState.correctPlacements = 0;

            renderPosition();

            // Mostrar overlay
            const overlay = document.getElementById('boardOverlay');
            const countdown = document.getElementById('overlayCountdown');
            if (overlay) {
                overlay.style.display = 'flex';
                overlay.classList.add('show');
            }

            // Countdown de memoria
            let timeLeft = 8;
            countdown.textContent = timeLeft;

            const interval = setInterval(() => {
                timeLeft--;
                countdown.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    startPlacementPhase();
                }
            }, 1000);
        }

        function startPlacementPhase() {
            const overlay = document.getElementById('boardOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.classList.remove('show');
            }

            window.gameState.memoryPhase = false;
            window.gameState.placementPhase = true;
            window.gameState.hiddenSquares = ['e1', 'e8'];
            window.gameState.position = {};

            renderPosition();
            createPieceBank(); // Crear banco con las piezas a colocar

            document.getElementById('phaseIndicator').textContent = 'üéØ Arrastra los reyes a sus casillas';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('homeBtn').addEventListener('click', () => {
                window.location.href = '../../index.html';
            });
        });
    </script>
    
    <!-- AdSense Initialization -->
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        (adsbygoogle = window.adsbygoogle || []).push({});
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</body>
</html>